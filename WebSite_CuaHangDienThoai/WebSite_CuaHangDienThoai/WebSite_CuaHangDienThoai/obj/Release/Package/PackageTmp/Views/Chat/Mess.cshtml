@model WebSite_CuaHangDienThoai.Models.tb_Customer
@{
    ViewBag.Title = "Tin nhắn";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}

<link href="~/Content/Css/Client/chat.css" rel="stylesheet" />
<br />
<br />
<br />
<br />
<main class="content">
    <div class="container p-5">
        <div class="card">
            <div class="row g-0">
                <div class="col-12 col-lg-12 col-xl-12">
                    <div class="py-2 px-4 border-bottom d-none d-lg-block">
                        <div class="d-flex align-items-center py-1">
                            <div class="position-relative">
                                <img src="~/images/Logo/LogoWeb.png" class="rounded-circle mr-1" alt="Logo" width="80" height="70" />
                            </div>
                            <div class="flex-grow-1 pl-3">
                                <strong>Hỗ trợ tư vấn</strong>
                                <div class="text-muted "><a href="/trang-chu" style="color: red; font-family: Poppins-Regular; ">LTD<span style="color: black; font-family: Poppins-Regular; ">MiniStore</span></a></div>
                            </div>
                        </div>
                    </div>
                    <div id="loadContenMess" data-id="@Model.CustomerId">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="flex-grow-0 py-3 px-4 border-top">
                        <div class="input-group">
                            <textarea class="form-control" id="ContentMess" placeholder="Nội dung hỏi"></textarea>
                            <button class="btn btn-primary btnSendMess" data-id="@Model.CustomerId">Gửi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.signalr/2.4.2/jquery.signalr.min.js"></script>
<script>
    var shouldScrollToBottom = true; // Biến để xác định xem có nên cuộn xuống dưới cùng hay không

    function loadPartialContent(id) {
        $.ajax({
            url: '/Chat/Partial_ContentMess/' + id, // Đường dẫn tới action Partial_ContentMess trong controller Chat
            type: 'GET',
            data: { id: id }, // Truyền id qua query string
            success: function (result) {
                // Lưu vị trí cuộn hiện tại
                var currentScrollPosition = $('#loadContenMess').scrollTop();
                var scrollHeight = $('#loadContenMess')[0].scrollHeight;
                var clientHeight = $('#loadContenMess').outerHeight();

                // Nạp nội dung nhận được vào div có id="loadContenMess"
                $('#loadContenMess').html(result);

                // Nếu đang ở cuối cùng hoặc người dùng đang xem tin nhắn cũ, cuộn đến vị trí hiện tại
                if (shouldScrollToBottom) {
                    var newScrollPosition = scrollHeight - clientHeight;
                    $('#loadContenMess').scrollTop(newScrollPosition);
                } else {
                    $('#loadContenMess').scrollTop(currentScrollPosition); // Giữ nguyên vị trí cuộn
                }
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    }

    // Hàm cuộn xuống dưới cùng
    function scrollToBottom() {
        var chatMessages = document.getElementById("loadContenMess");
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Cập nhật customerId từ Razor View (nếu cần thiết)
    var customerId = @Model.CustomerId;

    // Tải nội dung tin nhắn khi tài liệu đã sẵn sàng và sau mỗi 2 giây
    $(document).ready(function () {
        setInterval(function () {
            loadPartialContent(customerId);
        }, 2000);

        // Xử lý sự kiện scroll để xác định xem có nên cuộn xuống dưới cùng hay không
        $('#loadContenMess').on('scroll', function () {
            var scrollHeight = $(this)[0].scrollHeight;
            var clientHeight = $(this).outerHeight();
            var scrollPosition = $(this).scrollTop();

            // Nếu người dùng đang xem tin nhắn cũ, không tự động cuộn xuống dưới cùng
            shouldScrollToBottom = scrollPosition + clientHeight >= scrollHeight;
        });

        // Cuộn xuống dưới cùng khi tải lần đầu
        scrollToBottom();
    });

    // Xử lý sự kiện click nút gửi tin nhắn
    $('.btnSendMess').click(function () {
        var content = $('#ContentMess').val();

        // Kiểm tra và gửi tin nhắn
        if (!customerId) {
            Swal.fire({
                icon: "error",
                title: "Hết hàng...",
                text: "Khách hàng không hợp lệ"
            });

            setTimeout(function () {
                window.location.href = '/dang-nhap'; // Chuyển hướng đến trang đăng nhập
            }, 2000);

            return;
        }

        if (!content) {
            Swal.fire({
                icon: "error",
                title: "Lỗi...",
                text: "Nội dung tin nhắn không được để trống"
            });
            return;
        }

        // Gửi tin nhắn
        sendMessage(customerId, content);
    });
</script>
